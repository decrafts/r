---
layout: post
title: Интеллектуальная система вентиляции
permalink: /climate-control-system-for-the-apartment.html
categories: [ktulhu]
---

Дело было так. Сначала все было хорошо. Но потом подорожал газ. 
Поэтому жильцы дома скинулись на теплосчетчик и стали регулировать подачу тепла в квартиры.
Для сохранения того тепла окна были заменены на пластиковые и свежего воздуха стало не хватать,
а постоянно дергать окно на проветривание быстро надоело. 
Да и возникающий при этом сквозняк не радовал.

Было решено соорудить приточную вентиляцию производительностью 50-150 м<sup>3</sup> в час. 
Но не простую, а с возможностью регулировки мощности в зависимости от уровня CO<sub>2</sub> в помещении 
с целью поддержания оптимального для дыхания состава воздуха. 
Так как в окружающем воздухе иногда возникают заметные концентрации запахов было решено добавить 
датчики недопускающие их проникновения в помещение. Из этой затеи получилась:

**Интелектуальная система управления климатом на контроллере ESP8266** 

Которая решает задачи:
* Изменения температуры, влажности и давления вне помещения.
* Измерения загазованности по показателям метана, сероводорода, аммиака.
* Измерения уровня углекислого газа CO<sub>2</sub>, температуры и влажности в помещении.
* Управление приточной вентиляцией в ручном и автоматическом режимах.
* Мониторинга параметров и управления через Web-интерфейс.

ESP8266 был выбран из-за доступности, простоты сопряжения и
богатого успешного опыта отраженного в открытых источниках.
Все ожидания он оправдал и очень в нем обрадовала возможность обновления 
прошивки прямо из среды разработки Arduino IDE через WiFi.

**Внешние датчики**

![наружняя сторона](/images/2017/11/external-out.jpg)
С наружней стороны расположен датчик температуры, влажности и давления BME280 подулюченный к шине i2c и питанию +3.3v, 
датчик температуры и влажности AM2315 также подключенный к i2c и 3.3v и сенсоры датчиков аммиака, сероводорода и метана.
Все это прикрыто утеплителем на клейкой основе для отсечения тепла из помещения. Датчики дублируются для верификации показаний.

![внутренняя сторона](/images/2017/11/external-in.jpg)
С внутретренней стороны расположены:
* Датчик метана (CH4) MQ4 
* Датчик сероводорода (H2S) MQ136 
* Датчик аммиака (NH3) MQ137
* Модуль барометр датчик давления BMP180 	
* Датчик температуры и влажности I2C AM2315  
* АЦП модуль ADS1115 I2С, 4 канала, 16 бит
* 4-х канальний преобразователь логических уровней 5-3.3В, 3.3-5В для согласования сигналов устройств с разными напряжениями питания.

Датчики MQ запитаны от 5 вольт и их аналоговые выходы подключены к АЦП.
Коммутация выполнена гибкими проводами и сведена на клемник для подключения межблочного пятижильного кабеля. 
Кабель сечением 0.75mm2, назначение жил: напряжения 0V, +5V, +3.3V и сигналы i2c шины SCL, SDA.

![место установки](/images/2017/11/external-place.jpg)
Место установки - панель ограждения балкона, в которую врезана установочная электрическая коробка без дна. 

![колпак](/images/2017/11/external-cover.jpg)
Изнутри и снаружи модуль прикрыт съемными пластиковыми вентиляционными колпаками.

**Питание и реле**

![модуль реле](/images/2017/11/relay-v1.jpg)

* Модуль питания AC/DC 220В/5В 0,6А HLK-PM01 
* Модуль питания TSP-03 220В - 3.3В 3Вт
* I2C модуль для расширения выводов Arduino на PCF 8574T - управляет реле
* 8-ми канальний модуль реле

На клемник приходит кабель от блока наружних датчиков и уходит витая пара внутрь помещения на контроллер.
По витой паре аналогично идет 0V, +5V, +3.3V и сигналы i2c шины SCL, SDA. 
Из верхнего шкафчика поступает 220в на модули 5в и 3.3в питания, 
через реле подключен двухскоростной вентилятор TD-160/100 Silent. 

Блок помещен в отдельный металлический шкафчик на одну DIN рейку. 

**Контроллер**

{% include postimage.html content="/images/2017/11/controller-v1.jpg" %}

* Wi-Fi модуль NodeMcu ESP8266 CP2102 
* Датчик CO2 MH-Z19
* Датчик  и температуры HTU21 	
* Модуль датчика температуры и влажности DHT22  
* OLED Дисплей 1.3" 128x64 I2C 

Код [прошивки на github](https://github.com/codemaste/weather-station-esp8266).
Помимо рабочих функций в коде остаются закомментированные рудименты от часов реального времени, 
синхронизации их по NTP, датчика пыли.

**Сохранение и мониторинг погодных показателей online**

![колпак](/images/2017/11/dobrolubov-1.png)
Данные с XML интерфейса контроллера складываются в MySQL и могут отображаться на
[сайте в виде графиков за день/неделю/месяц](https://dobrolubov.com/).

Также данные отправляются [на сайт народного мониторинга](https://narodmon.ru/4231),
осуществляется [выгрузка в сервис ThingSpeak](https://thingspeak.com/channels/322829)
и [отображение на сервисе FreeBoard](https://freeboard.io/board/OgpGzU).

Веб-интерфейс управления, доступный на 80 порту по IP адресу контроллера, выглядит так:
![Интерфейс управления](/images/2017/11/control-interface-3.png)

Слева переключатели скоростей вентилятора 
(реализована версия для двух вентиляторов в сумме дающих 4 скорости, сейчас в наличии только 2 скорости одного вентилятора). 
В режиме AUTO скорости выбираются по заложеным в прошивке уровням показания датчика CO2.
По показаниям датчиков MQ можно устанавливать уровни отключения вентилятора.

Отдельный скрипт на домашнем сервере строит графики всех показателей, а не только уличных:
![графики](/images/2017/11/control-plot-1.png)

**Система приточной вентиляции**

![фильтры](/images/2017/11/vent-out.jpg)
Воздух забирается через отверстие в наружней стене лоджии, прикрытое колпаком.
На входе стоит фильтр класса G3, затем карманный фильтр класса G4 и оставлено место для установки угольного фильтра.
Все это прокачивается вентилятором TD-500/150 производительностью 500 м<sup>3<sup>/час.
Управление скоростью этого вентилятора происходит от двухканального реле темпаретуры.
Датчики реле температуры расположены над вентилятором.
На контроллер эта часть вентиляции не завязана и управляется исключительно из настенного щитка.

![TD-160/100](/images/2017/11/vent-in.jpg)
Подача воздуха в помещение осуществляется вентилятором TD-160/100 и управляется контроллером через блок реле.
На воздухозаборнике установлен обратный клапан для пресечения потоков при выключенном вентиляторе.

![вентиляция комнат](/images/2017/11/vent-room.jpg)
Регулируемая анемостатом часть воздуха остается в смежной с лоджией комнате, остальное уходит по вентканалу 
через стенку во вторую жилую комнату. Остальная квартира продувается и воздух удаляется через естественные вытяжки.

Вы закономерно скажете - но как же зимой-то? Зимой ведь холодно и приточку нужно подогревать.
Да и вообще - где тут интеллект? Правильное замечание. 

**Искусственный интеллект**

Как нельзя более кстати, в 2017 году обозначился новый тренд - построение искусственного интеллекта. 
Все почему-то строят его на видеокартах. За этой модой последовал и я, собрав небольшой кластерок на 
2кВт тепловой мощности, которую нужно куда-то девать.

![Искусственный интеллект](/images/2017/11/ai.jpg)

Летом с этм тепловым сиянием чистого разума успешно борется кондиционер Toshiba RAS-13N3KV, 
который вы могли заметить на стене над электрощитом. А зимой... 
Зимой в приточной системе создается разрыв и через него вся лоджия превращается в герметичную камеру приточной вентиляции.
Через вычислительный кластер в нее подается до 500 м<sup>3</sup> в час холодного фильтрованного воздуха. 
С потолка отбирается до 160 м<sup>3</sup> в час подогретого до комфортной температуры воздуха на нужды 
естественных интелектов, обитающих в смежных помещениях. Лишний теплый воздух выдувается на улицу через обратный клапан или форточку.
