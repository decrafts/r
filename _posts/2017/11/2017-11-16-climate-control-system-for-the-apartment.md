---
layout: post
title: Система управления климатом в квартире
permalink: /climate-control-system-for-the-apartment.html
categories: [ktulhu]
---

В связи с потребностью в свежем воздухе было решено соорудить приточную вентиляцию. 
Но не простую, а с возможностью регулировки мощности в зависимости от уровня CO<sub>2</sub> в помещении 
с целью поддержания оптимального для дыхания состава воздуха. 
Так как в окружающем воздухе иногда возникают заметные концентрации запахов было решено добавить 
датчики недопускающие их проникновения в помещение. Из этой затеи получилась:

**Система управления климатом на контроллере ESP8266** 

Позволяет осуществлять контроль наружней и внутренней климатической обстановки, 
управление приточной вентиляцией и мониторинг параметров.

Погодная станция решает задачи:
* Изменения температуры, влажности и давления вне помещения.
* Измерения загазованности по показателям метана, сероводорода, аммиака.
* Измерения уровня углекислого газа CO<sub>2</sub>, температуры и влажности в помещении.
* Управление приточной вентиляцией в ручном и автоматическом режимах.

**Внешние датчики**

![наружняя сторона](/images/2017/11/external-out.jpg)
С наружней стороны расположен датчик температуры, влажности и давления BME280 подулюченный к шине i2c и питаню +3.3v, 
датчик температуры и влажности AM2315 также подключенный к i2c и 3.3v и сенсоры датчиков аммиака, сероводорода и метана.
Все это прикрыто утеплителем на клейкой основе для отсечения тепла из помещения.

![внутренняя сторона](/images/2017/11/external-in.jpg)
С внутретренней стороны расположены:
* Датчик метана (CH4) MQ4 
* Датчик сероводорода (H2S) MQ136 
* Датчик аммиака (NH3) MQ137
* Модуль барометр датчик давления BMP180 	
* Датчик температуры и влажности I2C AM2315  
* АЦП модуль ADS1115 I2С, 4 канала, 16 бит
* 4-х канальний преобразователь логических уровней 5-3.3В, 3.3-5В для согласования сигналов устройств с разными напряжениями питания.

Датчики MQ запитаны от 5 вольт и их аналоговые выходы подключены к АЦП.
Коммутация выполнена гибкими проводами и сведена на клемник для подключения межблочного пятижильного кабеля. 
Кабель сечением 0.75mm2, назначение жил: напряжения 0V, 5V, 3.3V и сигналы i2c шины SCL, SDA.

![место установки](/images/2017/11/external-place.jpg)
Место установки - панель ограждения балкона, в которую врезана установочная электрическая коробка без дна. 

![колпак](/images/2017/11/external-cover.jpg)
Изнутри и снаружи модуль прикрыт съемными пластиковыми вентиляционными колпаками.

**Питание и реле**

![модуль реле](/images/2017/11/relay-v1.jpg)

* Модуль питания AC/DC 220В/5В 0,6А HLK-PM01 
* Модуль питания TSP-03 220В - 3.3В 3Вт
* I2C модуль для расширения выводов Arduino на PCF 8574T 	
* 8-ми канальний модуль реле

На клемник приходит кабель от блока наружних датчиков и уходит витая внутрь помещения на контроллер. 
Блок помещен в металлический шкафчик на одну DIN рейку. 
Через реле запитан двухскоростной вентилятор TD 160/100 Silent.

**Контроллер**

![модуль контроллера](/images/2017/11/controller-v1.jpg)

* Wi-Fi модуль NodeMcu ESP8266 CP2102 
* Датчик CO2 MH-Z19
* Датчик  и температуры HTU21 	
* Модуль датчика температуры и влажности DHT22  
* OLED Дисплей 1.3" 128x64 I2C 

Код [прошивки на github](https://github.com/codemaste/weather-station-esp8266).
Помимо рабочих функция в коде остаются закомментированные рудимнты от часов реального времени, 
синхронизации их по NTP, датчика пыли.

**Сохранение и мониторинг погодных показателей online**

Данные с XML интерфейса контроллера складываются в MySQL и могут отображаться на сайте в виде графиков за день/неделю/месяц:
[сайт с данными мониторинга погоды](https://dobrolubov.com/).

Также оптправляются данные [на сайт народного мониторинга](https://narodmon.ru/4231),
[выгрузка в сервис ThingSpeak](https://thingspeak.com/channels/322829),
[отображение на сервисе FreeBoard](https://freeboard.io/board/OgpGzU).

Интерфейс управления выглядит так:
![Интерфейс управления](/images/2017/11/control-interface.png)

Слева переключатели скоростей вентилятора (версия для двух вентиляторов в сумме дающих 4 скорости, сейчас толко 2 скорости). 
В режиме AUTO скорости выбираются по зашитым в прошивке уровням показания датчика CO2.
По показаниям датчиков MQ можно устанавливать уровни отключения вентилятора.

**Система приточной вентиляции**

![фильтры](/images/2017/11/vent-out.jpg)
Забор и фильтрация наружнего воздуха.
На входе фильтр класса G3, затем карманный G4 и место для установки угольного фильтра.
Все это прокачивается вентилятором TD-500/150 производительностью 500 м3/час.
Управление скоростью этого вентилятора происходит от двухканального реле темпаретуры.
Датчики реле температуры расположены над вентилятором.
На контроллер эта часть вентиляции не завязана и управляется исключительно из настенного щитка.

![TD-160/100](/images/2017/11/vent-in.jpg)
Подача воздуха в помещение осуществляется вентилятором TD-160/100 и управляется контроллером через блок реле.
На воздухозаборнике установлен обратный клапан для пресечения потоков при выключенном вентиляторе.
